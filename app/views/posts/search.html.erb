<h2 class="text-2xl font-bold mb-6 text-blue-900">投稿検索</h2>

<%= search_form_for @q, url: search_posts_path, method: :get, html: { class: "space-y-4" } do |f| %>
  <div
    data-controller="autocomplete"
    data-autocomplete-url-value="<%= autocomplete_posts_path %>"
  >
    <%= f.label :content_or_user_name_cont, "キーワード検索", class: "block text-sm font-semibold text-gray-700 mb-1" %>

    <!-- キーワード検索 -->
    <%= f.search_field :content_or_user_name_cont,
          placeholder: "投稿内容 or ユーザー名",
          class: "w-full border rounded px-3 py-2 text-sm",
          data: { autocomplete_target: "input", action: "input->autocomplete#search" } %>

    <!-- 候補表示 -->
    <ul data-autocomplete-target="results"
      class="border border-gray-300 bg-white mt-1 rounded shadow-md absolute z-10 w-full">
    </ul>
  </div>

  <!-- ジャンル絞り込み -->
  <div>
    <%= f.label :genre_id_eq, "ジャンルで絞り込み", class: "block text-sm font-semibold text-gray-700 mb-1" %>
    <%= f.collection_select :genre_id_eq, Genre.all, :id, :name,
          { include_blank: "すべて" },
          class: "w-full border rounded px-3 py-2 text-sm" %>
  </div>

  <!-- タグ検索 -->
  <div>
    <%= f.label :tags_name_cont, "タグ名で検索", class: "block text-sm font-semibold text-gray-700 mb-1" %>
    <%= f.search_field :tags_name_cont,
        placeholder: "例: タグ１",
        class: "w-full border rounded px-3 py-2 text-sm" %>
  </div>

  <%= f.submit "検索", class: "bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm" %>
<% end %>

<hr class="my-6">

<!-- =============================== -->
<!-- 検索結果表示 -->
<!-- =============================== -->

<% if @posts.any? %>
  <ul class="space-y-4">
    <% @posts.each do |post| %>
      <li class="p-4 border rounded bg-white shadow-sm">

        <!-- ユーザー名 -->
        <p class="font-semibold text-blue-600">
          <%= link_to post.user.display_name, user_path(post.user), class: "hover:underline" %>
        </p>

        <!-- ジャンル + タグバッジ -->
        <div class="mt-1 flex flex-wrap gap-1 items-center">

          <!--  ジャンルバッジ -->
          <%= link_to search_posts_path(q: { genre_id_eq: post.genre.id }),
              class: "px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200" do %>
            <%= post.genre.name %>
          <% end %>

          <!-- タグ -->
          <% post.tags.each do |tag| %>
            <%= link_to posts_path(tag_id: tag.id),
              class: "px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300" do %>
              #<%= tag.name %>
            <% end %>
          <% end %>
        </div>

        <!-- 投稿本文（短縮） -->
        <p class="text-gray-700 mt-1">
          <%= link_to truncate(post.content, length: 60),
                post_path(post),
                class: "hover:underline text-gray-800" %>
        </p>

      </li>
    <% end %>
  </ul>

<% else %>
  <p class="text-gray-500 mt-4">該当する投稿はありません。</p>
<% end %>
