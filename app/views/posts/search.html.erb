<h2 class="text-2xl font-bold mb-6 text-blue-900">投稿検索</h2>

<%= search_form_for @q, url: search_posts_path, method: :get, html: { class: "space-y-4" } do |f| %>
  <div
    data-controller="autocomplete"
    data-autocomplete-url-value="<%= autocomplete_posts_path %>"
  >
    <%= f.label :content_or_user_name_cont, "キーワード検索", class: "block text-sm font-semibold text-gray-700 mb-1" %>

    <!-- Stimulusのターゲット指定 -->
    <%= f.search_field :content_or_user_name_cont,
          placeholder: "投稿内容 or ユーザー名",
          class: "w-full border rounded px-3 py-2 text-sm",
          data: { autocomplete_target: "input", action: "input->autocomplete#search" } %>

    <!-- 候補表示用 -->
    <ul data-autocomplete-target="results"
      class="border border-gray-300 bg-white mt-1 rounded shadow-md absolute z-10 w-full">
    </ul>
  </div>

  <div>
    <%= f.label :genre_id_eq, "ジャンルで絞り込み", class: "block text-sm font-semibold text-gray-700 mb-1" %>
    <%= f.collection_select :genre_id_eq, Genre.all, :id, :name,
          { include_blank: "すべて" },
          class: "w-full border rounded px-3 py-2 text-sm" %>
  </div>

  <div>
    <%= f.label :tags_name_cont, "タグ名で検索", class: "block text-sm font-semibold text-gray-700 mb-1" %>
    <%= f.search_field :tags_name_cont,
        placeholder: "例: タグ１",
        class: "w-full border rounded px-3 py-2 text-sm" %>
  </div>

  <%= f.submit "検索", class: "bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm" %>
<% end %>

<hr class="my-6">

<% if @posts.any? %>
  <ul class="space-y-4">
    <% @posts.each do |post| %>
      <li class="p-4 border rounded bg-white shadow-sm">
        <p class="font-semibold"><%= link_to post.user.display_name, user_path(post.user) %></p>
        <p class="text-gray-700"><%= truncate(post.content, length: 60) %></p>
        <p class="text-sm text-gray-500">ジャンル: <%= post.genre.name %></p>

        <!-- タグ表示 -->
        <div class="mt-1 flex flex-wrap gap-1">
          <% post.tags.each do |tag| %>
            <%= link_to posts_path(tag_id: tag.id),
              class: "px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs hover:bg-gray-300" do %>
                #<%= tag.name %>
            <% end %>
          <% end %>
        </div>
      </li>
    <% end %>
  </ul>
<% else %>
  <p class="text-gray-500 mt-4">該当する投稿はありません。</p>
<% end %>
