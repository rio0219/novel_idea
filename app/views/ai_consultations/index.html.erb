<h1 class="text-2xl font-bold mb-6"><%= t("titles.ai_consultation") %></h1>

<%= render "shared/error_messages", object: @ai_consultation %>

<!-- Stimulusコントローラのラッパ -->
<div data-controller="ai-chat">
  <%= form_with model: @ai_consultation,
              url: ai_consultations_path,
              data: {
                action: "submit->ai-chat#submit",
                "ai-chat-target": "form"
              },
              class: "space-y-4" do |f| %>

    <!-- 入力エリア -->
    <div>
      <%= f.label :content, t("activerecord.attributes.ai.content"), class: "block mb-2 font-semibold" %>
      <%= f.text_area :content,
            rows: 4,
            class: "w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none" %>
    </div>

    <!-- ボタン配置 -->
    <div class="flex justify-between items-center mt-4">
      <% if session[:return_to].present? %>
        <%= link_to t("buttons.ai_back"), session[:return_to],
          class: "bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded" %>
      <% end %>

      <div class="flex-1 flex justify-center">
        <%= f.submit t("buttons.consultation"),
          class: "bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded" %>
      </div>
    </div>
  <% end %>

  <!-- スピナー -->
  <div data-ai-chat-target="spinner" class="hidden flex justify-center mt-6">
    <div class="h-10 w-10 border-4 border-gray-300 border-t-blue-500 rounded-full animate-spin"></div>
  </div>

  <hr class="my-8">

  <!-- ★ 最新の相談（常に1件だけ） -->
  <div data-ai-chat-target="latest" class="mb-8">
    <% if @latest_consultation.present? %>
      <%= render "ai_consultations/ai_consultation", consultation: @latest_consultation %>
    <% end %>
  </div>

  <h2 class="text-xl font-semibold mb-4"><%= t("titles.previous_consultation") %></h2>

  <!-- ★ 過去の相談（2件目以降） -->
  <div data-ai-chat-target="consultations" class="flex flex-col gap-4">
    <% @consultations.each do |consultation| %>
      <%= render "ai_consultations/ai_consultation", consultation: consultation %>
    <% end %>
  </div>
</div>
